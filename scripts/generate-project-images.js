/**
 * Guardian Roofing - Project Image Generator
 * Uses Gemini 2.0 Flash Image API with image-to-image editing for consistent before/after pairs
 *
 * Usage: npm run generate-images
 */

import { GoogleGenAI } from "@google/genai";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import dotenv from "dotenv";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load environment variables from parent directory's .env.local
dotenv.config({ path: path.join(__dirname, "..", ".env.local") });

const API_KEY = process.env.Gemini_API_KEY;
const OUTPUT_DIR = path.join(__dirname, "..", "images");

// Before/After pairs - after images are generated by editing the before image
const beforeAfterPairs = [
  {
    id: "1",
    description: "Brick colonial - roof replacement",
    before: {
      filename: "before-after-1-before.webp",
      prompt: `Professional real estate photography of a two-story brick colonial style house with a severely damaged roof. Key details:
- Classic red-brown brick exterior with white painted window trim
- Symmetrical facade with centered front door and covered porch with white columns
- 6 windows visible on front (3 upper, 3 lower), white shutters
- Roof showing significant storm damage: missing shingles, exposed underlayment, visible wear
- Concrete walkway leading to front steps
- Mature green lawn with foundation shrubs (boxwood hedges)
- Overcast gray sky suggesting recent storm
- NO people in the image
- Wide angle shot showing complete front facade
- Photorealistic, high-quality architectural photography style`
    },
    after: {
      filename: "before-after-1-after.webp",
      editPrompt: `Edit this house image to show a completed roof renovation:

CHANGE ONLY:
- Replace the damaged roof with a brand new charcoal gray architectural shingle roof in pristine condition
- Change the sky to bright sunny blue with a few white clouds
- Add a happy middle-aged Caucasian male homeowner (45-55 years old) standing in the front yard, arms crossed proudly, wearing a casual navy polo shirt, natural realistic appearance

KEEP EXACTLY THE SAME:
- The brick exterior color and pattern
- All windows (same size, position, white trim, shutters)
- The front door and porch with white columns
- The walkway and front steps
- The lawn and foundation shrubs
- The overall house shape and proportions

This should look like the same house photographed after professional roof work was completed.`
    }
  },
  {
    id: "2",
    description: "Ranch house - siding replacement",
    before: {
      filename: "before-after-2-before.webp",
      prompt: `Professional real estate photography of a single-story ranch style house with damaged vinyl siding. Key details:
- Low-profile ranch home, approximately 1400 sq ft appearance
- Attached two-car garage on the right side with white garage door
- Damaged beige/cream colored vinyl siding: faded sections, warped panels, storm damage
- 4 front-facing windows with simple white frames
- Dark gray/charcoal asphalt shingle roof in decent condition
- Concrete driveway leading to garage
- Simple lawn, minimal landscaping
- Overcast cloudy day
- NO people in the image
- Wide angle shot showing complete front facade including garage
- Photorealistic, high-quality architectural photography style`
    },
    after: {
      filename: "before-after-2-after.webp",
      editPrompt: `Edit this house image to show completed siding renovation:

CHANGE ONLY:
- Replace the damaged beige siding with brand new modern blue-gray vinyl siding, professionally installed
- Add fresh white trim around all windows and the garage door
- Change the sky to bright sunny blue
- Add a happy middle-aged Caucasian female homeowner (40-50 years old) standing near the front of the house, warm genuine smile, wearing a casual light blue blouse, natural realistic appearance

KEEP EXACTLY THE SAME:
- The house shape and footprint
- The garage position and door
- All window positions and sizes
- The roof (keep the same dark gray shingles)
- The driveway
- The lawn area

This should look like the same house photographed after professional siding installation.`
    }
  }
];

// Standalone project images (not before/after pairs)
const standaloneImages = [
  {
    filename: "project-10.webp",
    prompt: `Professional photography of an emergency storm damage roof repair scene at a residential home. Key details:
- Large fallen tree branch on residential roof showing significant impact damage
- Professional roofing contractors on scene actively working
- Blue emergency tarp covering the damaged section of roof
- Workers wearing safety gear (hard hats, harnesses)
- White work truck with ladder rack visible in driveway
- Partially cloudy sky, active workday lighting
- Sense of professional emergency response and competence
- Wide angle shot showing the scope of damage and repair work
- Photorealistic, documentary-style photography`,
    description: "Storm damage project - emergency tree damage repair"
  }
];

async function generateImage(ai, prompt, filename, description) {
  console.log(`\nüì∏ Generating: ${filename}`);
  console.log(`   ${description}`);

  try {
    const response = await ai.models.generateContent({
      model: "gemini-2.0-flash-exp-image-generation",
      contents: prompt,
      config: {
        responseModalities: ["image", "text"],
      }
    });

    const imageData = extractImageData(response);
    if (imageData) {
      const imageBuffer = Buffer.from(imageData.data, "base64");
      const outputPath = path.join(OUTPUT_DIR, filename);
      fs.writeFileSync(outputPath, imageBuffer);
      console.log(`   ‚úÖ Saved: ${outputPath}`);
      return true;
    } else {
      console.error(`   ‚ùå No image data in response for ${filename}`);
      logResponseText(response);
      return false;
    }
  } catch (error) {
    console.error(`   ‚ùå Error: ${error.message}`);
    if (error.message.includes("API key")) {
      console.error("   Please check your Gemini_API_KEY in .env.local");
    }
    return false;
  }
}

async function generateEditedImage(ai, inputImagePath, editPrompt, outputFilename, description) {
  console.log(`\nüé® Editing: ${outputFilename}`);
  console.log(`   ${description}`);
  console.log(`   Using input: ${path.basename(inputImagePath)}`);

  try {
    // Read the before image as base64
    const imageBuffer = fs.readFileSync(inputImagePath);
    const base64Image = imageBuffer.toString("base64");

    // Determine mime type from extension
    const ext = path.extname(inputImagePath).toLowerCase();
    const mimeType = ext === ".webp" ? "image/webp" : ext === ".png" ? "image/png" : "image/jpeg";

    const response = await ai.models.generateContent({
      model: "gemini-2.0-flash-exp-image-generation",
      contents: [
        {
          parts: [
            { inlineData: { mimeType, data: base64Image } },
            { text: editPrompt }
          ]
        }
      ],
      config: {
        responseModalities: ["image", "text"],
      }
    });

    const imageData = extractImageData(response);
    if (imageData) {
      const outputBuffer = Buffer.from(imageData.data, "base64");
      const outputPath = path.join(OUTPUT_DIR, outputFilename);
      fs.writeFileSync(outputPath, outputBuffer);
      console.log(`   ‚úÖ Saved: ${outputPath}`);
      return true;
    } else {
      console.error(`   ‚ùå No image data in response for ${outputFilename}`);
      logResponseText(response);
      return false;
    }
  } catch (error) {
    console.error(`   ‚ùå Error: ${error.message}`);
    return false;
  }
}

function extractImageData(response) {
  if (response.candidates && response.candidates.length > 0) {
    for (const part of response.candidates[0].content?.parts || []) {
      if (part.inlineData?.mimeType?.startsWith("image/")) {
        return part.inlineData;
      }
    }
  }
  return null;
}

function logResponseText(response) {
  if (response.text) {
    console.log("   Response text:", response.text.slice(0, 200));
  }
}

async function main() {
  console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  console.log("   Guardian Roofing - Project Image Generator");
  console.log("   (with image-to-image editing for consistent before/after)");
  console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");

  // Verify API key
  if (!API_KEY || API_KEY === "your_api_key_here") {
    console.error("\n‚ùå ERROR: Gemini_API_KEY not found or not set in .env.local");
    console.error("   Get a free API key at: https://aistudio.google.com/app/apikey");
    process.exit(1);
  }

  console.log(`\nüìÅ Output directory: ${OUTPUT_DIR}`);
  console.log(`üìù Before/After pairs: ${beforeAfterPairs.length}`);
  console.log(`üìù Standalone images: ${standaloneImages.length}`);

  // Ensure output directory exists
  if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  // Initialize Gemini AI
  const ai = new GoogleGenAI({ apiKey: API_KEY });

  let successCount = 0;
  let failCount = 0;

  // Generate before/after pairs
  for (const pair of beforeAfterPairs) {
    console.log(`\n‚îÄ‚îÄ‚îÄ Pair ${pair.id}: ${pair.description} ‚îÄ‚îÄ‚îÄ`);

    // Step 1: Generate the "before" image
    const beforeSuccess = await generateImage(
      ai,
      pair.before.prompt,
      pair.before.filename,
      `Before - ${pair.description}`
    );

    if (beforeSuccess) {
      successCount++;

      // Wait before editing
      console.log("   ‚è≥ Waiting 3 seconds before generating 'after' version...");
      await new Promise(resolve => setTimeout(resolve, 3000));

      // Step 2: Generate the "after" image by editing the "before" image
      const beforePath = path.join(OUTPUT_DIR, pair.before.filename);
      const afterSuccess = await generateEditedImage(
        ai,
        beforePath,
        pair.after.editPrompt,
        pair.after.filename,
        `After - ${pair.description}`
      );

      if (afterSuccess) {
        successCount++;
      } else {
        failCount++;
      }
    } else {
      failCount += 2; // Count both before and after as failed
      console.log(`   ‚ö†Ô∏è  Skipping 'after' image since 'before' failed`);
    }

    // Delay between pairs
    if (beforeAfterPairs.indexOf(pair) < beforeAfterPairs.length - 1) {
      console.log("   ‚è≥ Waiting 3 seconds before next pair...");
      await new Promise(resolve => setTimeout(resolve, 3000));
    }
  }

  // Generate standalone images
  if (standaloneImages.length > 0) {
    console.log("\n‚îÄ‚îÄ‚îÄ Standalone Images ‚îÄ‚îÄ‚îÄ");

    for (const config of standaloneImages) {
      const success = await generateImage(ai, config.prompt, config.filename, config.description);
      if (success) {
        successCount++;
      } else {
        failCount++;
      }

      if (standaloneImages.indexOf(config) < standaloneImages.length - 1) {
        console.log("   ‚è≥ Waiting 3 seconds before next image...");
        await new Promise(resolve => setTimeout(resolve, 3000));
      }
    }
  }

  console.log("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  console.log(`   Complete! ‚úÖ ${successCount} succeeded, ‚ùå ${failCount} failed`);
  console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");

  if (failCount > 0) {
    process.exit(1);
  }
}

main().catch(console.error);
